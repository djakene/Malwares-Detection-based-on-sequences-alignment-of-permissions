from lxml import etree
import re
import os
import subprocess
import csv
import shutil
import numpy as np
import pandas as pd

z=pd.read_csv(" path of intmodelmal.csv")
p=z.apply(pd.to_numeric)
m=pd.read_csv("path of modelmal.csv")
liste1=[]
liste4=[]
k=0
liste3=np.zeros((len(m.columns)),float)
somme=0.0
for i in p:
  if(k<len(m.columns)):
     liste3[k]=int(float(i))
     somme=int(float(i))+somme
     k=k+1
for i in m:
   liste1.append(str(i))

###################################/
d="path of apk files"
a=os.listdir(d)
os.chdir(d)
Nb_mal1=0
Nb_good1=0
Nb_mal2=0
Nb_good2=0 
Nb_mal3=0
Nb_good3=0
Nb_mal4=0
Nb_good4=0
for i in a:
   liste=[]
   lste=[]
   doublon=0
   #liste.append(str(i))
   c=os.path.join(d,i)
   past=str(c)
   t=len(past)
   m=past[0:(t-4):1]
   os.chdir(d)
   os.system("apktool d " +str(c))
   os.chdir(m)
   tree = etree.parse("AndroidManifest.xml")
   for user in tree.xpath("/manifest/uses-permission"):
     a=user.attrib
     c=str(a)
     b=len(c)
     if (b<104):
       g=(c[73:(b-2):1])
       liste.append(g)
     else :
        h=(c[86:(b-2):1])
        liste.append(h)
   os.chdir(d)
   taille=len(liste)
   print(taille)
   s1=0.0
   taille=len(liste)
   for p in liste:
      if  p in liste1:
         s1+=liste3[liste1.index(p)]
         taille-=taille
      if p in lste:
        doublon+=1
      else:
         lste.append(p)

   s2=s1/somme
   liste4.append(s2)
   trouve=0
   if  s2>=0.37 or doublon>1:
       Nb_mal1+=1 
       
   if s2>=0.35 or doublon>1:
        Nb_mal2+=1 
   if s2>=0.348 or doublon>1:
        Nb_mal3+=1 
   if s2>=0.340 or doublon>1:
        Nb_mal4+=1 
    
   
   shutil.rmtree(m)

print ("le nombre de malware  pour 0.37 est: ", Nb_mal1)
print ("le nombre de malware  pour 0.35 est: ", Nb_mal2)
print ("le nombre de malware  pour 0.348 est: ", Nb_mal3)
print ("le nombre de malware  pour 0.340 est: ", Nb_mal4)
  #os.chdir(d)




