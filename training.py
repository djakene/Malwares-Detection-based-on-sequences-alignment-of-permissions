from lxml import etree
import re
import os
import subprocess
import csv
import shutil
import numpy as np
d="path of apk files"
a=os.listdir(d)
os.chdir(d)
liste2=[]
liste3=np.zeros((1000),int)
with open('path of tpmal.csv', 'wb') as myfile:
  wr = csv.writer(myfile, quoting=csv.QUOTE_ALL)
  for i in a:
   liste=[]
   #liste.append(str(i))
   c=os.path.join(d,i)
   past=str(c)
   t=len(past)
   m=past[0:(t-4):1]
   os.chdir(d)#change directory
   os.system("apktool d " +str(c))#execution apktool
   os.chdir(m)
   tree = etree.parse("AndroidManifest.xml")
   for user in tree.xpath("/manifest/uses-permission"):
     a=user.attrib
     c=str(a)
     b=len(c)
     if (b<104):
       g=(c[73:(b-2):1])
       liste.append(g)
     else :
        h=(c[86:(b-2):1])
        liste.append(h)
   os.chdir(d)
   for p in liste:#deletion of duplicates
    if p not in liste2:
       liste2.append(p)
    else :
       liste3[liste2.index(p)]+=1
   wr.writerow(liste)
   shutil.rmtree(m)#deletion of directory m
with open('path of apk modelmal.csv', 'wb') as myfile:
  wr = csv.writer(myfile, quoting=csv.QUOTE_ALL)
  wr.writerow(liste2)

with open('path of intmodelmal.csv', 'wb') as myfile:
  wr = csv.writer(myfile, quoting=csv.QUOTE_ALL)
  wr.writerow(liste3)
 


